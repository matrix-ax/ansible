---

- name: Authentik redis
  docker_container:
   name: authentik_redis
   image: redis:alpine
   restart_policy: unless-stopped

- name: Authentik server
  docker_container:
   name: authentik_server
   image: ghcr.io/goauthentik/server:stable # Currently 2021.10.1
   #image: ghcr.io/goauthentik/server:2021.10.1-rc2
   pull: yes
   command: server
   restart_policy: unless-stopped
   env:
    AUTHENTIK_EMAIL__FROM: "{{ authentik_email_from }}"
    AUTHENTIK_EMAIL__HOST: "{{ authentik_email_host }}"
    AUTHENTIK_EMAIL__PORT: "{{ authentik_email_port }}"
    AUTHENTIK_EMAIL__USE_TLS: "{{ authentik_email_use_tls }}"
    AUTHENTIK_EMAIL__TIMEOUT: '10'
    AUTHENTIK_REDIS__HOST: authentik_redis
    AUTHENTIK_SECRET_KEY: "{{ authentik_secret_key }}"
    AUTHENTIK_LOG_LEVEL: "{{ authentik_log_level }}"
    AUTHENTIK_POSTGRESQL__HOST: "{{ authentik_psql_host }}"
    AUTHENTIK_POSTGRESQL__USER: "{{ authentik_psql_user }}"
    AUTHENTIK_POSTGRESQL__NAME: "{{ authentik_psql_user }}"
    AUTHENTIK_POSTGRESQL__PASSWORD: "{{ authentik_psql_pw }}"
   volumes:
    - /opt/docker/appdata/authentik/templates:/templates
    - /opt/docker/appdata/authentik/media:/media
   ports:
    - "127.0.0.1:9000:9000"

- name: Authentik worker
  docker_container:
   name: authentik_worker
   image: ghcr.io/goauthentik/server:stable # Currently 2021.10.1
   #image: ghcr.io/goauthentik/server:2021.10.1-rc2
   pull: yes
   command: worker
   restart_policy: unless-stopped
   # This is optional, and can be removed. If you remove this, the following will happen
   # - The permissions for the /backups and /media folders aren't fixed, so make sure they are 1000:1000
   # - The docker socket can't be accessed anymore
   user: root
   env:
    AUTHENTIK_EMAIL__FROM: "{{ authentik_email_from }}"
    AUTHENTIK_EMAIL__HOST: "{{ authentik_email_host }}"
    AUTHENTIK_EMAIL__PORT: "{{ authentik_email_port }}"
    AUTHENTIK_EMAIL__USE_TLS: "{{ authentik_email_use_tls }}"
    AUTHENTIK_EMAIL__TIMEOUT: '10'
    AUTHENTIK_REDIS__HOST: authentik_redis
    AUTHENTIK_SECRET_KEY: "{{ authentik_secret_key }}"
    AUTHENTIK_LOG_LEVEL: "{{ authentik_log_level }}"
    AUTHENTIK_POSTGRESQL__HOST: "{{ authentik_psql_host }}"
    AUTHENTIK_POSTGRESQL__USER: "{{ authentik_psql_user }}"
    AUTHENTIK_POSTGRESQL__NAME: "{{ authentik_psql_user }}"
    AUTHENTIK_POSTGRESQL__PASSWORD: "{{ authentik_psql_pw }}"
   volumes:
    - /opt/docker/appdata/authentik/backups:/backups
    - /opt/docker/appdata/authentik/media:/media
    - /opt/docker/appdata/authentik/templates:/templates
    - /var/run/docker.sock:/var/run/docker.sock
